<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grand Luxury Interactive Tree</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@19/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@19/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <style>
        body { margin: 0; background-color: #041e16; overflow: hidden; font-family: 'Georgia', serif; }
        #video-container { position: fixed; bottom: 20px; right: 20px; width: 140px; height: 105px; border: 1px solid #D4AF37; border-radius: 4px; z-index: 100; box-shadow: 0 0 15px rgba(212,175,55,0.3); }
        video { transform: scaleX(-1); width: 100%; height: 100%; object-fit: cover; }
        .gold-glow { text-shadow: 0 0 10px rgba(212,175,55,0.8); }
    </style>
</head>
<body>
    <div id="root"></div>
    <div id="video-container"><video id="input-video"></video></div>
    <audio id="bg-music" loop src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3"></audio>

    <script type="text/babel">
        const { useRef, useEffect, useState } = React;

        const GOLD = "#D4AF37";
        const EMERALD = "#041e16";
        const COUNT = 1200; // 粒子数量增加，更浓密

        const ChristmasApp = () => {
            const mountRef = useRef(null);
            const [status, setStatus] = useState('CHAOS');
            const [audioPlaying, setAudioPlaying] = useState(false);
            
            const stateRef = useRef({ 
                status: 'CHAOS', 
                currentPos: [], 
                targetPos: [], 
                chaosPos: [],
                rotations: []
            });

            // 切换音频
            const toggleAudio = () => {
                const audio = document.getElementById('bg-music');
                if (audio.paused) {
                    audio.play();
                    setAudioPlaying(true);
                } else {
                    audio.pause();
                    setAudioPlaying(false);
                }
            };

            useEffect(() => {
                const scene = new THREE.Scene();
                scene.background = new THREE.Color(EMERALD);
                scene.fog = new THREE.Fog(EMERALD, 5, 45);

                const camera = new THREE.PerspectiveCamera(40, window.innerWidth / window.innerHeight, 0.1, 1000);
                camera.position.set(0, 2, 22);

                const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setPixelRatio(window.devicePixelRatio);
                mountRef.current.appendChild(renderer.domElement);

                // 奢华光照系统
                const mainLight = new THREE.PointLight(GOLD, 500, 100);
                mainLight.position.set(5, 15, 10);
                scene.add(mainLight);
                scene.add(new THREE.AmbientLight(0xffffff, 0.2));

                // 装饰物：混合形状 (球体与棱锥)
                const geometry = new THREE.IcosahedronGeometry(0.15, 0); 
                const material = new THREE.MeshStandardMaterial({ 
                    color: GOLD, metalness: 1, roughness: 0.1, emissive: "#4a3c0a" 
                });
                const mesh = new THREE.InstancedMesh(geometry, material, COUNT);
                scene.add(mesh);

                // 分布算法：Golden Ratio Cone (黄金比例圆锥分布)
                const dummy = new THREE.Object3D();
                for (let i = 0; i < COUNT; i++) {
                    // Chaos
                    const cp = new THREE.Vector3((Math.random()-0.5)*50, (Math.random()-0.5)*40, (Math.random()-0.5)*50);
                    
                    // Target (Tree Shape)
                    const y = Math.random() * 16;
                    const radius = (16 - y) * 0.28;
                    const angle = i * 0.1; // 螺旋分布
                    const tp = new THREE.Vector3(Math.cos(angle)*radius, y - 8, Math.sin(angle)*radius);

                    stateRef.current.chaosPos.push(cp);
                    stateRef.current.targetPos.push(tp);
                    stateRef.current.currentPos.push(cp.clone());
                    stateRef.current.rotations.push(new THREE.Euler(Math.random()*Math.PI, Math.random()*Math.PI, 0));
                }

                const animate = () => {
                    requestAnimationFrame(animate);
                    const isFormed = stateRef.current.status === 'FORMED';
                    const lerpSpeed = isFormed ? 0.07 : 0.03;

                    for (let i = 0; i < COUNT; i++) {
                        const target = isFormed ? stateRef.current.targetPos[i] : stateRef.current.chaosPos[i];
                        stateRef.current.currentPos[i].lerp(target, lerpSpeed);
                        
                        dummy.position.copy(stateRef.current.currentPos[i]);
                        dummy.rotation.set(
                            stateRef.current.rotations[i].x += 0.01,
                            stateRef.current.rotations[i].y += 0.01,
                            0
                        );
                        // 树顶部的装饰缩小
                        const s = isFormed ? (1.2 - (stateRef.current.currentPos[i].y + 8) / 20) : 1;
                        dummy.scale.setScalar(s);
                        dummy.updateMatrix();
                        mesh.setMatrixAt(i, dummy.matrix);
                    }
                    mesh.instanceMatrix.needsUpdate = true;
                    renderer.render(scene, camera);
                };
                animate();

                window.addEventListener('resize', () => {
                    camera.aspect = window.innerWidth / window.innerHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(window.innerWidth, window.innerHeight);
                });
            }, []);

            // 手势识别
            useEffect(() => {
                const videoElement = document.getElementById('input-video');
                const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
                hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.5 });
                
                hands.onResults((results) => {
                    if (results.multiHandLandmarks && results.multiHandLandmarks[0]) {
                        const lm = results.multiHandLandmarks[0];
                        const dist = Math.hypot(lm[4].x - lm[8].x, lm[4].y - lm[8].y);
                        const newStatus = dist < 0.12 ? 'FORMED' : 'CHAOS';
                        if (newStatus !== stateRef.current.status) {
                            stateRef.current.status = newStatus;
                            setStatus(newStatus);
                        }
                    }
                });

                const camera = new Camera(videoElement, {
                    onFrame: async () => { await hands.send({image: videoElement}); },
                    width: 640, height: 480
                });
                camera.start();
            }, []);

            return (
                <div className="relative w-full h-screen">
                    {/* 奢华 UI */}
                    <div className="absolute top-16 left-16 z-20 pointer-events-none">
                        <h1 className="text-white text-6xl font-black tracking-tighter italic gold-glow leading-none">GRAND</h1>
                        <h1 className="text-[#D4AF37] text-6xl font-black tracking-widest leading-none ml-1">INTERACTIVE</h1>
                        <div className="h-1 w-48 bg-[#D4AF37] my-4 shadow-[0_0_15px_#D4AF37]"></div>
                        <p className="text-[#D4AF37] tracking-[0.4em] text-sm uppercase opacity-80">2025 Holiday Elite Edition</p>
                    </div>

                    <div ref={mountRef} />

                    {/* 控制面板 */}
                    <div className="absolute bottom-12 left-16 flex flex-col gap-4">
                        <button 
                            onClick={toggleAudio}
                            className="bg-transparent border border-[#D4AF37] px-6 py-2 text-[#D4AF37] text-xs hover:bg-[#D4AF37] hover:text-black transition-all uppercase tracking-widest pointer-events-auto"
                        >
                            {audioPlaying ? 'Music: ON' : 'Music: OFF (Click to Start)'}
                        </button>
                        <div className="text-[#D4AF37] opacity-40 text-[10px] tracking-widest uppercase">
                            Gesture control: {status === 'FORMED' ? 'Precision Assembly' : 'Particle Dispersion'}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ChristmasApp />);
    </script>
</body>
</html>